name: CVFactory CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9.18'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Set environment based on branch
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Setting production environment"
            cp .env.example .env
            echo "DEBUG=False" >> .env
          else
            echo "Setting development environment"
            cp .env.example .env
            echo "DEBUG=True" >> .env
          fi
      
      - name: Run tests
        run: |
          python manage.py test
  
  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9.18'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Set environment based on branch
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Setting production environment"
            cp .env.example .env
            # ë°°í¬ í™˜ê²½ì—ì„œëŠ” ì‹¤ì œ API í‚¤ ë“±ì„ GitHub Secretsì—ì„œ ê°€ì ¸ì™€ ì„¤ì •
            echo "DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" >> .env
            echo "ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}" >> .env
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env
            echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> .env
            echo "API_KEY=${{ secrets.API_KEY }}" >> .env
            echo "CSRF_TRUSTED_ORIGINS=${{ secrets.CSRF_TRUSTED_ORIGINS }}" >> .env
            echo "CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}" >> .env
            echo "DEBUG=False" >> .env
          else
            echo "Setting development environment"
            cp .env.example .env
            echo "DJANGO_SECRET_KEY=${{ secrets.DEV_DJANGO_SECRET_KEY }}" >> .env
            echo "ALLOWED_HOSTS=${{ secrets.DEV_ALLOWED_HOSTS }}" >> .env
            echo "DEBUG=True" >> .env
            # ê°œë°œ í™˜ê²½ ì„¤ì •
            echo "GOOGLE_CLIENT_ID=dummy-dev-client-id" >> .env
            echo "GOOGLE_CLIENT_SECRET=dummy-dev-client-secret" >> .env
            echo "GROQ_API_KEY=dummy-dev-groq-api-key" >> .env
          fi
      
      - name: Collect static files
        run: python manage.py collectstatic --noinput
      
      - name: Run migrations
        run: python manage.py migrate --noinput
      
      - name: Create logs directory with proper permissions
        run: |
          mkdir -p logs
          chmod -R 755 logs
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            .
            !.git
            !.github
  
  deploy-dev:
    if: github.ref == 'refs/heads/develop'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: .
      
      - name: Deploy to Render.com Development Environment
        uses: JorgeLNJunior/render-deploy@v1.4.3
        with:
          service_id: ${{ secrets.RENDER_DEV_SERVICE_ID }}
          api_key: ${{ secrets.RENDER_API_KEY }}
          wait: true
  
  deploy-prod:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: .
      
      - name: Deploy to Render.com Production Environment
        uses: JorgeLNJunior/render-deploy@v1.4.3
        with:
          service_id: ${{ secrets.RENDER_PROD_SERVICE_ID }}
          api_key: ${{ secrets.RENDER_API_KEY }}
          wait: true 
  
  notify:
    needs: [test, build, deploy-prod, deploy-dev]
    runs-on: ubuntu-latest
    if: always()  # í•­ìƒ ì‹¤í–‰
    steps:
      - name: Check workflow status
        id: status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "workflow_status=failure" >> $GITHUB_OUTPUT
          else
            echo "workflow_status=success" >> $GITHUB_OUTPUT
          fi
      
      - name: Notify workflow status
        if: steps.status.outputs.workflow_status == 'failure'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo, owner } = context.repo;
            const run_id = context.runId;
            
            github.rest.issues.create({
              owner,
              repo,
              title: `ğŸš¨ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨: ${context.workflow}`,
              body: `**ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.**
              
              - **ì €ì¥ì†Œ:** ${owner}/${repo}
              - **ì›Œí¬í”Œë¡œìš°:** ${context.workflow}
              - **ì»¤ë°‹:** ${context.sha}
              - **ë¸Œëœì¹˜:** ${context.ref}
              - **ìƒì„¸ ì •ë³´:** https://github.com/${owner}/${repo}/actions/runs/${run_id}
              
              ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`
            }); 